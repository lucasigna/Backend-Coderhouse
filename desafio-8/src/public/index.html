<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./estilo.css">
    <script src="/socket.io/socket.io.js"></script>
    <title>Desafío 6</title>
</head>
<body>
    <h1>Formulario de productos</h1>
    <form id="form">
        <label for="title">Título</label>
        <input required type="text" id="title" name="title">
        <label for="price">Precio</label>
        <input required type="number" id="price" name="price">
        <label for="thumbnail">URL Foto</label>
        <input required type="text" id="thumbnail" name="thumbnail">
        <input type="submit" value="Subir">
    </form>
    <div id="productList">
        <div>
            <p>Id</p>
            <p>Título</p>
            <p>Precio</p>
            <p>URL Foto</p>
        </div>
    </div>
    <form id="formChat">
        <input required type="text" id="mail" placeholder="Correo">
        <div id="chatList">
            
        </div>
        <input required type="text" id="message" placeholder="Escribe un mensaje">
        <input type="submit" id="send" value="Enviar mensaje">
    </form>
    <script src="../data/messages"></script>
    <script>
        const socket = io();
        const form = document.getElementById("form")
        const chatList = document.getElementById("chatList")
        const formChat = document.getElementById("formChat")

        window.onload = () => {
            fetch('http://localhost:8080/api/productos')
            .then( resp => resp.json() )
            .then( (data) => {
                for (const prod of data) {
                    const elem = document.createElement('div')
                    elem.innerHTML = `
                            <p>${prod.id}</p>
                            <p>${prod.title}</p>
                            <p>${prod.price}</p>
                            <p>${prod.thumbnail}</p>
                    `
                    productList.appendChild(elem)
                }
            })
            fetch('http://localhost:8080/api/mensajes')
            .then( resp => resp.json() )
            .then( (data) => {
                for (const msg of data) {
                    const timestamp = new Date(msg.timestamp)
                    const elem = document.createElement('div')
                    elem.innerHTML = `
                            <p>${msg.mail}:</p>
                            <p>${msg.message}</p>
                            <p>${timestamp.getDate()}/${timestamp.getMonth()+1}/${timestamp.getFullYear()} ${timestamp.getHours()}:${timestamp.getMinutes()}:${timestamp.getSeconds()}</p>
                    `
                    chatList.appendChild(elem)
                }
            })
        }

        form.addEventListener("submit",(e) => {
            e.preventDefault();
            const title = document.getElementById("title").value
            const price = document.getElementById("price").value
            const thumbnail = document.getElementById("thumbnail").value

            fetch('http://localhost:8080/api/productos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title, price, thumbnail })
            })
            .then( res => res.json())
            .then( (data) => {
                socket.emit('newProduct', data)
            })
        })

        socket.on('newProduct', (data) => {
            const elem = document.createElement('div')
                    elem.innerHTML = `
                            <p>${data.id}</p>
                            <p>${data.title}</p>
                            <p>${data.price}</p>
                            <p>${data.thumbnail}</p>
                    `
                    productList.appendChild(elem)
        })

        formChat.addEventListener('submit', (e) => {
            e.preventDefault()
            const mail = document.getElementById("mail").value
            const message = document.getElementById("message").value

            fetch('http://localhost:8080/api/mensajes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mail, message })
            })
            .then( res => res.json())
            .then( (data) => {
                socket.emit('newMessage', data)
            })
        })

        socket.on('newMessage', (data) => {
            const timestamp = new Date(data.timestamp)
            const elem = document.createElement('div')
                    elem.innerHTML = `
                        <p>${data.mail}:</p>
                        <p>${data.message}</p>
                        <p>${timestamp.getDate()}/${timestamp.getMonth()+1}/${timestamp.getFullYear()} ${timestamp.getHours()}:${timestamp.getMinutes()}:${timestamp.getSeconds()}</p>
                    `
                    chatList.appendChild(elem)
        })
    </script>
</body>
</html>